<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Algo Trading</title>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
		
		<link rel="stylesheet" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css">
		<script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
		
		<style>
			.table-container {
				margin-top: 30px;
			}
			
			.dataTables_length {
				margin-top: 5px;
			}
			
			th {
			  border: 1px solid #dddddd;
			}
		</style>
		
	</head>

	<body>

		<div class="container mt-5 mb-5">
			<div class="d-flex justify-content-center mb-5">
				<h3>Algo Trading</h3>
			</div>
		
			<div class="row">
				<div class="col-6">
					<div class="form-group">
						<label for="ticker">Stock Name:</label>
						<select class="form-control" id="ticker"></select>
					</div>
					<div class="d-flex flex-row">
						<button type="button" class="btn btn-primary mt-5" id="fetch_profit_lost_data">Get Results</button>
					</div>
				</div>
				
				<div class="col-6">
					<div class="form-group">
						<label for="pattern">Pattern:</label>
						<select class="form-control" id="pattern"></select>
					</div>
					<div class="d-flex flex-row-reverse">
						<button type="button" class="btn btn-primary mt-5" id="refresh_stocks_results" disabled>Refresh Patterns</button>
					</div>
				</div>
			</div>
			
			<hr>
			
			<div class="table-container">
			
				<div class="d-flex justify-content-center">
					<h3>Recent Pattern Occurances</h3>
				</div>
			
				<table class="cell-border mt-5" id="pattern-table">
					<thead>
						<tr>
							<th>SL No</th>
							<th>DATE</th>
							<th>PATTERN</th>
							<th>STOCK</th>
						</tr>
					</thead>
					<tbody>
						
					</tbody>
				</table>
			
			</div>
			
			<hr>
			
			<div class="table-container" id="profit_loss_div" style="display:none;">
			
				<div class="d-flex justify-content-center">
					<h3>Profit and Loss: <span id="ticker-name"></span> for <span id="pattern-name"></span></h3>
				</div>
			
				<table class="cell-border mt-5" id="profit-loss-table">
					<thead>
						<tr>
							<th>DATE</th>
							<th>DAYS</th>
							<th>P&L</th>
							<th>VOLUME</th>
							<th>MACD</th>
							<th>MACDS</th>
							<th>RSI14</th>
						</tr>
					</thead>
					<tbody>
						
					</tbody>
				</table>
			
			</div>
			
		</div>
		
	</body>
	
	<script>
	
	//var DOMAIN = "http://192.168.0.243:105/";
	var DOMAIN = "https://tdtrading.herokuapp.com/";
	
	$(document).ready(function(){
		populate_tickers();
		populate_patterns();
		populate_pattern_occurances();
		
		$("#refresh_stocks_results").click(function(){
			refresh_stocks_results();
		});
		
		$("#fetch_profit_lost_data").click(function(){
			fetch_profit_lost_data();
		});
	});
	
	function populate_tickers() {
		$.ajax({
			url: DOMAIN + "algotrading/get_all_tickers",
			type: "GET",
			dataType: 'json',
			success: function(tickers_array){
				for(var index in tickers_array) {
					var htmlContent = '<option value="' + tickers_array[index] + '">' + tickers_array[index] + '</option>';
					$("#ticker").append(htmlContent);
				}
			}
		});
	}
	
	function populate_patterns() {
		$.ajax({
			url: DOMAIN + "algotrading/get_all_patterns",
			type: "GET",
			dataType: 'json',
			success: function(patterns_array){
				for(var index in patterns_array) {
					var htmlContent = '<option value="' + patterns_array[index] + '">' + patterns_array[index] + '</option>';
					$("#pattern").append(htmlContent);
				}
			}
		});
	}
	
	function refresh_stocks_results() {
		$("#refresh_stocks_results").attr("disabled", true);
		$.ajax({
			url: DOMAIN + "algotrading/refresh_pattern_results",
			type: "GET",
			success: function(response){
				location.reload();
			}
		});
	}
	
	function populate_pattern_occurances() {
		$.ajax({
			url: DOMAIN + "algotrading/get_pattern_occurances",
			type: "GET",
			dataType: 'json',
			success: function(response){
				for(var index in response) {
					var htmlContent = '<tr>' +
								  '<td>' + response[index]['Slno'] + '</td>' +
								  '<td>' + response[index]['Date'] + '</td>' +
								  '<td>' + response[index]['Name'] + '</td>' +
								  '<td>' + response[index]['Pattern'] + '</td>' +
								  '</tr>';
								  
					$("#pattern-table tbody").append(htmlContent);
				}
				
				$("#pattern-table").DataTable({
					searching: false,
					info: false,
					"dom": '<"top"f>rt<"bottom"lp><"clear">'
				});
			}
		});
	}
	
	function fetch_profit_lost_data() {
		var ticker = encodeURI($("#ticker").val());
		var pattern = encodeURI($("#pattern").val());
	
		$.ajax({
			type: "GET",
			url: DOMAIN + "algotrading/fetch_profit_lost_data/"+ ticker +"/"+ pattern +"/",
			dataType: 'json',
			success: function(response){
				$("#ticker-name").html($("#ticker").val());
				$("#pattern-name").html($("#pattern").val());
			
				
				$("#profit-loss-table").DataTable().destroy();
				$("#profit-loss-table tbody").html("");			
				for(var index in response) {
					var htmlContent = '<tr>' +
									  '<td>' + response[index]['DATE'] + '</td>' +
									  '<td>' + response[index]['DAYS'] + '</td>' +
									  '<td>' + response[index]['P&L'] + '</td>' +
									  '<td>' + response[index]['VOLUME'] + '</td>' +
									  '<td>' + response[index]['MACD'] + '</td>' +
									  '<td>' + response[index]['MACDS'] + '</td>' +
									  '<td>' + response[index]['RSI14'] + '</td>' +
									  '</tr>';
									  
					$("#profit-loss-table tbody").append(htmlContent);
				}
				
				$("#profit-loss-table").DataTable({
					destroy: true,
					searching: false,
					info: false,
					"order": [],
					"dom": '<"top"f>rt<"bottom"lp><"clear">'
				});
				
				$("#profit_loss_div").show();
			}
		});
	}
	
	</script>
</html>
